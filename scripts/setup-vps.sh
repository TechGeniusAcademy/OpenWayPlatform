#!/bin/bash
# –°–∫—Ä–∏–ø—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ VPS –¥–ª—è OpenWay Platform
# –ó–∞–ø—É—Å–∫–∞—Ç—å –Ω–∞ VPS –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ –≤—Ö–æ–¥–∞

set -e

echo "üöÄ –ù–∞—á–∏–Ω–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫—É VPS –¥–ª—è OpenWay..."

# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã
echo "üì¶ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã..."
sudo apt update && sudo apt upgrade -y

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –ø–∞–∫–µ—Ç–æ–≤
echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Node.js 20..."
curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
sudo apt install -y nodejs

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ PostgreSQL
echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ PostgreSQL..."
sudo apt install -y postgresql postgresql-contrib

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Nginx
echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Nginx..."
sudo apt install -y nginx

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Certbot –¥–ª—è SSL
echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Certbot..."
sudo apt install -y certbot python3-certbot-nginx

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Git
echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Git..."
sudo apt install -y git

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ PM2
echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ PM2..."
sudo npm install -g pm2

# –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞
echo "üìÅ –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞..."
sudo mkdir -p /var/www/openway
sudo chown -R ubuntu:ubuntu /var/www/openway

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ PostgreSQL
echo "üóÑÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ PostgreSQL..."
sudo -u postgres psql -c "CREATE USER openway WITH PASSWORD 'OpenWay2026SecurePass!';" || true
sudo -u postgres psql -c "CREATE DATABASE openway_platform OWNER openway;" || true
sudo -u postgres psql -c "GRANT ALL PRIVILEGES ON DATABASE openway_platform TO openway;" || true

# –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è (–∑–∞–º–µ–Ω–∏—Ç–µ URL –Ω–∞ –≤–∞—à)
echo "üì• –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è..."
cd /var/www/openway
# git clone https://github.com/YOUR_USERNAME/YOUR_REPO.git . || true

echo "‚úÖ –ë–∞–∑–æ–≤–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
echo ""
echo "–°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:"
echo "1. –°–∫–ª–æ–Ω–∏—Ä—É–π—Ç–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π: git clone YOUR_REPO_URL /var/www/openway"
echo "2. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ .env —Ñ–∞–π–ª"
echo "3. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏: npm install"
echo "4. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –º–∏–≥—Ä–∞—Ü–∏–∏"
echo "5. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ Nginx"
echo "6. –ü–æ–ª—É—á–∏—Ç–µ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç"
